<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>AutoAppDev Studio</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml" />
    <link rel="manifest" href="manifest.json" />
    <meta name="theme-color" content="#2767ff" />
    <link rel="stylesheet" href="styles.css" />
    <script>
      window.__AUTOAPPDEV_CONFIG__ = window.__AUTOAPPDEV_CONFIG__ || {};
    </script>
    <script src="config.local.js"></script>
    <script>
      window.__AUTOAPPDEV_CONFIG__.API_BASE_URL =
        window.__AUTOAPPDEV_CONFIG__.API_BASE_URL || "http://127.0.0.1:8788";
    </script>
    <script src="api-client.js" defer></script>
    <script src="app.js" defer></script>
  </head>
  <body data-theme="light">
    <header class="topbar">
      <div class="brand">
        <div class="logo">AA</div>
        <div class="brand-text">
          <div class="brand-name">AutoAppDev Studio</div>
          <div class="brand-sub">Scratch-like pipeline controller</div>
        </div>
      </div>

      <div class="controls">
        <div class="select">
          <label>Agent</label>
          <select id="agent-select">
            <option value="codex">Codex</option>
            <option value="copilot" disabled>Copilot (coming)</option>
            <option value="gemini" disabled>Gemini (coming)</option>
            <option value="claude" disabled>Claude (coming)</option>
          </select>
        </div>
        <div class="select">
          <label>Model</label>
          <select id="model-select">
            <option value="gpt-5.3-codex">gpt-5.3-codex</option>
            <option value="gpt-5.3-codex-mini" disabled>gpt-5.3-codex-mini</option>
          </select>
        </div>

        <button class="btn btn--primary" id="btn-start">Start</button>
        <button class="btn" id="btn-pause">Pause</button>
        <button class="btn" id="btn-resume">Resume</button>
        <button class="btn btn--danger" id="btn-stop">Stop</button>
        <span class="ctrl-msg" id="ctrl-msg" aria-live="polite"></span>

        <button class="btn btn--ghost" id="btn-theme">Light</button>
      </div>
    </header>

    <main class="layout">
      <section class="panel panel--toolbox">
        <div class="panel-head">
          <div class="panel-title">Blocks</div>
          <div class="panel-hint">Drag to canvas</div>
        </div>
        <div class="toolbox" id="toolbox">
          <div class="block block--plan" draggable="true" data-block="plan">Plan</div>
          <div class="block block--work" draggable="true" data-block="work">Work</div>
          <div class="block block--debug" draggable="true" data-block="debug">Debug</div>
          <div class="block block--fix" draggable="true" data-block="fix">Fix</div>
          <div class="block block--summary" draggable="true" data-block="summary">Summary</div>
          <div class="block block--summary" draggable="true" data-block="update_readme">Update README</div>
          <div class="block block--release" draggable="true" data-block="commit_push">Commit+Push</div>
        </div>
      </section>

      <section class="panel panel--canvas">
        <div class="panel-head">
          <div class="panel-title">Program</div>
          <div class="panel-actions">
            <button class="btn btn--ghost" id="btn-clear">Clear</button>
            <button class="btn btn--ghost" id="btn-export">Export JSON</button>
            <button class="btn btn--ghost" id="btn-send-plan">Send Plan</button>
            <button class="btn btn--ghost" id="btn-save-script">Save Script</button>
            <button class="btn btn--ghost" id="btn-load-script">Load Script</button>
          </div>
        </div>
        <div class="canvas" id="canvas" aria-label="Program canvas">
          <div class="canvas-empty" id="canvas-empty">
            Drop blocks here to build a pipeline.
          </div>
        </div>
        <pre class="export" id="export" hidden></pre>
      </section>

      <section class="panel panel--right">
        <div class="tabs">
          <button class="tab is-active" data-tab="status">Status</button>
          <button class="tab" data-tab="chat">Inbox</button>
          <button class="tab" data-tab="logs">Logs</button>
          <button class="tab" data-tab="actions">Actions</button>
          <button class="tab" data-tab="script">Script</button>
        </div>

        <div class="tabview" id="tab-status">
          <div class="kv">
            <div class="k">Backend</div>
            <div class="v badge badge--unknown" id="backend-health">unknown</div>
          </div>
          <div class="kv">
            <div class="k">DB</div>
            <div class="v badge badge--unknown" id="db-health">unknown</div>
          </div>
          <div class="kv">
            <div class="k">Pipeline</div>
            <div class="v badge badge--unknown" id="pipeline-status">idle</div>
          </div>
          <div class="kv">
            <div class="k">PID</div>
            <div class="v" id="pipeline-pid">-</div>
          </div>
          <div class="hintbox">
            Use Inbox to inject guidance while the pipeline runs. Messages are written to a runtime inbox that scripts can consume.
          </div>

          <div class="divider"></div>
          <div class="panel-title">Workspace</div>
          <div class="panel-hint">Materials + shared context (persisted per workspace)</div>

          <div class="actionsection scriptbar">
            <input class="input" id="ws-slug" placeholder="my_workspace" />
            <button class="btn btn--ghost" id="ws-load">Load</button>
            <button class="btn btn--ghost" id="ws-save">Save</button>
          </div>

          <div class="actiongrid">
            <div class="select">
              <label>Default language</label>
              <select id="ws-language">
                <option value="zh-Hans">zh-Hans</option>
                <option value="zh-Hant">zh-Hant</option>
                <option value="en" selected>en</option>
                <option value="ja">ja</option>
                <option value="ko">ko</option>
                <option value="vi">vi</option>
                <option value="ar">ar</option>
                <option value="fr">fr</option>
                <option value="es">es</option>
              </select>
            </div>
            <div class="select">
              <label>Shared context path (optional)</label>
              <input class="input" id="ws-context-path" placeholder="docs/shared_context.md" />
            </div>
          </div>

          <div class="select actionsection">
            <label>Materials paths (one per line)</label>
            <textarea
              class="input action-text"
              id="ws-materials"
              spellcheck="false"
              placeholder="materials\nmaterials/screenshots"
            ></textarea>
          </div>

          <div class="select actionsection">
            <label>Shared context text</label>
            <textarea
              class="input action-text"
              id="ws-context-text"
              spellcheck="false"
              placeholder="Shared context visible to all tasks in this workspace..."
            ></textarea>
          </div>

          <div class="script-msg" id="ws-msg" aria-live="polite"></div>
          <div class="hintbox">
            Workspace config is validated to stay under <code>auto-apps/&lt;workspace&gt;/</code>.
            Paths must be workspace-relative (no <code>..</code>, no absolute paths).
          </div>
        </div>

        <div class="tabview" id="tab-chat" hidden>
          <div class="chatlog" id="chatlog"></div>
          <div class="chatbar">
            <input class="input" id="chat-input" placeholder="Send a message to the pipeline inbox..." />
            <button class="btn btn--primary" id="chat-send">Send</button>
          </div>
        </div>

        <div class="tabview" id="tab-logs" hidden>
          <div class="logbar">
            <select class="input" id="log-select">
              <option value="pipeline">pipeline.log</option>
              <option value="backend">backend.log</option>
            </select>
            <button
              class="btn btn--ghost"
              id="log-follow"
              aria-label="Auto-scroll follow"
              aria-pressed="true"
              title="Toggle auto-scroll (pause to select/copy)"
            >
              Pause
            </button>
            <button class="btn btn--ghost" id="log-refresh">Refresh</button>
          </div>
          <pre class="logview" id="logview"></pre>
        </div>

        <div class="tabview" id="tab-actions" hidden>
          <div class="actionbar">
            <button class="btn btn--ghost" id="actions-refresh">Refresh</button>
            <button class="btn btn--ghost" id="actions-new">New</button>
            <button class="btn btn--ghost" id="actions-save">Save</button>
            <button class="btn btn--ghost btn--danger" id="actions-delete">Delete</button>
          </div>

          <div class="actionlist" id="actions-list" aria-label="Action definitions"></div>

          <div class="divider"></div>

          <div class="actiongrid">
            <div class="select">
              <label>ID</label>
              <input class="input" id="action-id" type="text" placeholder="(new)" disabled />
            </div>
            <div class="select">
              <label>Enabled</label>
              <select id="action-enabled">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div class="select">
              <label>Title</label>
              <input class="input" id="action-title" placeholder="Action title" />
            </div>
            <div class="select">
              <label>Kind</label>
              <select id="action-kind">
                <option value="prompt">prompt</option>
                <option value="command">command</option>
              </select>
            </div>
          </div>

          <div class="actionsection" id="action-section-prompt">
            <div class="select">
              <label>Prompt</label>
              <textarea
                class="input action-text"
                id="action-prompt"
                spellcheck="false"
                placeholder="Prompt template..."
              ></textarea>
            </div>
            <div class="actiongrid">
              <div class="select">
                <label>Agent (optional)</label>
                <input class="input" id="action-agent" placeholder="codex" />
              </div>
              <div class="select">
                <label>Model (optional)</label>
                <input class="input" id="action-model" placeholder="gpt-5.3-codex" />
              </div>
            </div>
            <div class="actiongrid">
              <div class="select">
                <label>Reasoning</label>
                <select id="action-reasoning">
                  <option value="low">low</option>
                  <option value="medium" selected>medium</option>
                  <option value="high">high</option>
                  <option value="xhigh">xhigh</option>
                </select>
              </div>
              <div class="select">
                <label>Timeout (s, optional)</label>
                <input class="input" id="action-timeout" type="number" min="5" max="300" step="1" placeholder="45" />
              </div>
            </div>
          </div>

          <div class="actionsection" id="action-section-command" hidden>
            <div class="select">
              <label>Cmd</label>
              <textarea
                class="input action-text"
                id="action-cmd"
                spellcheck="false"
                placeholder="bash scripts/my_tool.sh"
              ></textarea>
            </div>
            <div class="actiongrid">
              <div class="select">
                <label>Shell (v0)</label>
                <input class="input" id="action-shell" value="bash" disabled />
              </div>
              <div class="select">
                <label>CWD (repo-relative)</label>
                <input class="input" id="action-cwd" placeholder="." />
              </div>
              <div class="select">
                <label>Timeout (s, optional)</label>
                <input
                  class="input"
                  id="action-timeout-cmd"
                  type="number"
                  min="1"
                  max="3600"
                  step="1"
                  placeholder="60"
                />
              </div>
            </div>
          </div>

          <div class="script-msg" id="actions-msg" aria-live="polite"></div>
          <div class="hintbox">
            Kind changes are not supported in v0. For command actions, <code>shell</code> is always <code>bash</code> and
            <code>cwd</code> must stay within the repo.
          </div>
        </div>

        <div class="tabview" id="tab-script" hidden>
          <div class="scriptbar">
            <input class="input" id="script-file" type="file" accept=".aaps,.sh,.txt" />
            <button class="btn btn--ghost" id="script-parse" title="Parse AAPS v1 formatted script into blocks">
              Parse AAPS -> Blocks
            </button>
            <button
              class="btn btn--ghost"
              id="script-import-shell"
              title="Import a shell script annotated with # AAPS: lines"
            >
              Import Shell -> Blocks
            </button>
            <button
              class="btn btn--ghost"
              id="script-from-blocks"
              title="Generate an AAPS v1 script from the current blocks"
            >
              From Blocks
            </button>
            <button
              class="btn btn--ghost"
              id="script-download-aaps"
              title="Download the generated AAPS v1 formatted script (.aaps)"
            >
              Download AAPS
            </button>
            <button
              class="btn btn--ghost"
              id="script-download-runner"
              title="Download a generated runnable shell runner (.sh)"
            >
              Download Runner
            </button>
          </div>
          <textarea
            class="script-text"
            id="script-text"
            spellcheck="false"
            placeholder="Paste AAPS v1 here (AUTOAPPDEV_PIPELINE 1 ...), or paste an annotated .sh (lines starting with # AAPS:) and click Import..."
          ></textarea>
          <div class="script-msg" id="script-msg" aria-live="polite"></div>
          <div class="hintbox">
            Canvas visualization is step-level only: STEP.block values become blocks. TASK/STEP titles and ACTIONs are not
            visualized (yet).
          </div>
        </div>
      </section>
    </main>
  </body>
</html>
